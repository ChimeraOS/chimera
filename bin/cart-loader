#!/bin/bash

function check {
	out=$(gbopyrator)
	
	if echo $out | grep ".gb "; then
		# Game Boy cart detected
		echo "gb"
		return 0
	elif echo $out | grep ".gbc "; then
		# Game Boy Color cart detected
		echo "gbc"
		return 0
	else
		# No valid cart detected
		return 1
	fi
}

function load {
	# TODO: use the actual rom name so we can consistently use saves
	launcher=$1
	ROM=/tmp/gboperator-rom-dump

	gbopyrator --dump-rom $ROM
	$launcher $ROM
}

cart_type=$(check)
code=$?

if [ "$1" == "--check" && "$code" == "0" ]; then
	# cart detected, trigger cart launch through Steam
	steam steam://rungameid/2956691123
elif [ -z "$1" && -n "$cart_type" ]; then
	# no parameters means this script has been called from Steam, launch the cart directly if one is detected
	load $cart_type
else
	exit $code
fi
